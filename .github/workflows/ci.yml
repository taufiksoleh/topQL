name: CI/CD Pipeline

on:
  push:
    branches: [ main, master, claude/** ]
  pull_request:
    branches: [ main, master ]

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pylint black isort

    - name: Run Black (code formatter check)
      run: |
        black --check --diff topql.py examples.py test_topql.py || true

    - name: Run isort (import sorting check)
      run: |
        isort --check-only --diff topql.py examples.py test_topql.py || true

    - name: Run Flake8 (style guide enforcement)
      run: |
        # Stop the build if there are Python syntax errors or undefined names
        flake8 topql.py examples.py test_topql.py --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-zero treats all errors as warnings. Max line length set to 100
        flake8 topql.py examples.py test_topql.py --count --exit-zero --max-complexity=10 --max-line-length=100 --statistics

    - name: Run Pylint (code analysis)
      run: |
        pylint topql.py examples.py test_topql.py --exit-zero --max-line-length=100 || true

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install coverage

    - name: Run unit tests
      run: |
        python -m unittest test_topql -v

    - name: Run tests with coverage
      run: |
        coverage run -m unittest test_topql
        coverage report -m
        coverage html

    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      if: matrix.python-version == '3.9'
      with:
        name: coverage-report
        path: htmlcov/

    - name: Generate coverage badge data
      if: matrix.python-version == '3.9'
      run: |
        coverage report | tail -n 1 | awk '{print "COVERAGE=" $4}' >> $GITHUB_ENV

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [lint, test]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Run example script
      run: |
        python examples.py

    - name: Test database operations
      run: |
        python -c "
        from topql import Database
        db = Database()
        db.execute('CREATE TABLE test (id INT, name VARCHAR(50))')
        db.execute('INSERT INTO test VALUES (1, \"Test\")')
        result = db.execute('SELECT * FROM test')
        assert result['count'] == 1
        assert result['rows'][0]['name'] == 'Test'
        print('âœ“ Database operations working correctly')
        "

    - name: Test all SQL operations
      run: |
        python -c "
        from topql import Database

        print('Testing CREATE TABLE...')
        db = Database()
        db.execute('CREATE TABLE users (id INT, name VARCHAR(50), age INT, active BOOLEAN)')

        print('Testing INSERT...')
        db.execute('INSERT INTO users VALUES (1, \"Alice\", 30, TRUE)')
        db.execute('INSERT INTO users VALUES (2, \"Bob\", 25, FALSE)')
        db.execute('INSERT INTO users VALUES (3, \"Charlie\", 35, TRUE)')

        print('Testing SELECT...')
        result = db.execute('SELECT * FROM users')
        assert result['count'] == 3

        print('Testing SELECT with WHERE...')
        result = db.execute('SELECT * FROM users WHERE age > 25')
        assert result['count'] == 2

        print('Testing SELECT with ORDER BY...')
        result = db.execute('SELECT * FROM users ORDER BY age')
        assert result['rows'][0]['age'] == 25

        print('Testing SELECT with LIMIT...')
        result = db.execute('SELECT * FROM users LIMIT 2')
        assert result['count'] == 2

        print('Testing UPDATE...')
        db.execute('UPDATE users SET age = 26 WHERE name = \"Bob\"')
        result = db.execute('SELECT age FROM users WHERE name = \"Bob\"')
        assert result['rows'][0]['age'] == 26

        print('Testing DELETE...')
        db.execute('DELETE FROM users WHERE age < 30')
        result = db.execute('SELECT * FROM users')
        assert result['count'] == 2

        print('âœ“ All SQL operations passed!')
        "

  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [lint, test, integration-test]
    if: always()

    steps:
    - name: Check build status
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ“ Linting completed" >> $GITHUB_STEP_SUMMARY
        echo "âœ“ Unit tests completed" >> $GITHUB_STEP_SUMMARY
        echo "âœ“ Integration tests completed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "All checks passed! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
